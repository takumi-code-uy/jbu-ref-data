<!doctype html>
<meta charset="utf-8">
<title>Estadísticas del referente • JBU</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;margin:24px;color:#0f172a}
  .card{border:1px solid #e5e7eb;border-radius:14px;max-width:920px;margin:0 auto;padding:18px}
  h1{margin:0 0 8px;font-size:22px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
  .chip{display:inline-block;background:#f1f5f9;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:14px}
  .btn{display:inline-block;border:1px solid #cbd5e1;border-radius:10px;padding:8px 12px;text-decoration:none;color:#0f172a}
  .muted{color:#64748b}
</style>

<div id="app" class="card">Cargando…</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const code = (qs.get('c')||'').toUpperCase();
  const view = (qs.get('view')||'').toLowerCase();

  // Lee el JSON del mismo repo (GitHub Pages)
  const DATA_URL = 'data/ref_stats.json?ts=' + Date.now();
  const $app = document.getElementById('app');
  const $ = (h) => ($app.innerHTML = h);

  const money = v => '$' + (Math.round((+v||0))).toLocaleString('es-UY');

  const landing = (ref) => $(`
    <h1>¡Bienvenido!</h1>
    <div class="row"><span class="muted">Este link pertenece al referente con código:</span> <span class="chip">${code}</span></div>
    <div class="row">
      <a class="btn" href="#" id="copy">Copiar código</a>
      <a class="btn" href="?c=${code}&view=stats">Ver estadísticas del referente</a>
    </div>
    <p class="muted" style="margin-top:8px">Mensaje sugerido: Hola, vengo recomendado por ${ref?.name||'un referente'}, código ${code}.</p>
  `);

  const stats = (ref, updatedAt) => $(`
    <h1>Estadísticas del referente</h1>
    <div class="row">
      <span class="muted">Código:</span> <span class="chip">${code}</span>
      ${ref?.name ? `<span class="chip">${ref.name}</span>` : ''}
    </div>

    ${
      (ref && (ref.count>0 || ref.total_paid>0 || ref.total_pending>0))
      ? `<div class="row">
           <span class="chip">Referidos: ${ref.count||0}</span>
           <span class="chip">Pagados: ${ref.paid||0}</span>
           <span class="chip">Con payout: ${ref.count||0}</span>
           <span class="chip">Ganado (pagado): ${money(ref.total_paid||0)}</span>
           <span class="chip">Pendiente: ${money(ref.total_pending||0)}</span>
         </div>`
      : `<p class="muted">No hay movimientos registrados (aún).</p>`
    }

    <div class="row"><a class="btn" href="?c=${code}">Volver</a></div>
    <div class="muted" style="margin-top:8px">Actualizado: ${new Date(updatedAt).toLocaleString('es-UY')}</div>
  `);

  const notFound = () => $(`
    <h1>Estadísticas del referente</h1>
    <div class="row"><span class="muted">Código:</span> <span class="chip">${code||'-'}</span></div>
    <p class="muted">No encontramos este código (aún).</p>
    <div class="row"><a class="btn" href="./">Inicio</a></div>
  `);

  fetch(DATA_URL)
    .then(r => r.ok ? r.json() : Promise.reject(r.statusText))
    .then(data => {
      const ref = (data && data.referrers && code) ? data.referrers[code] : null;
      if (!ref){ notFound(); return; }
      (view==='stats') ? stats(ref, data.updated_at || new Date().toISOString()) : landing(ref);
      const copy = document.getElementById('copy');
      if (copy) copy.addEventListener('click', (e)=>{
        e.preventDefault(); navigator.clipboard.writeText(code);
        copy.textContent = '¡Copiado!'; setTimeout(()=>copy.textContent='Copiar código', 1100);
      });
    })
    .catch(err => {
      console.error(err);
      $(`
        <h1>Estadísticas del referente</h1>
        <p class="muted">No se pudieron cargar los datos. Intentá nuevamente.</p>
      `);
    });
})();
</script>
